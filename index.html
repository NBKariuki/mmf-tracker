<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMF - Weekly Contributions Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin: 15px 0;
            font-size: 1.2rem;
            color: #84fab0;
        }

        /* TABLE CONTAINER WITH FROZEN COLUMNS */
        .table-wrapper {
            position: relative;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 85vh;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.7rem;
        }

        /* FROZEN COLUMNS - Alias and Total */
        th:nth-child(1),
        th:nth-child(2),
        td:nth-child(1),
        td:nth-child(2) {
            position: sticky;
            left: 0;
            z-index: 10;
            background: rgba(30, 30, 58, 0.95);
        }

        td:nth-child(2),
        th:nth-child(2) {
            left: 60px; /* Width of first column */
        }

        /* HEADER STYLING */
        thead {
            position: sticky;
            top: 0;
            z-index: 20;
            background: rgba(30, 30, 58, 0.98);
        }

        th {
            padding: 6px 4px;
            font-weight: 600;
            text-align: center;
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            font-size: 0.65rem;
            white-space: nowrap;
        }

        /* Alias column - minimal width */
        th:nth-child(1),
        td:nth-child(1) {
            width: 60px;
            min-width: 60px;
            text-align: left;
            padding-left: 6px;
            font-size: 0.65rem;
        }

        /* Total column - compact */
        th:nth-child(2),
        td:nth-child(2) {
            width: 55px;
            min-width: 55px;
            font-weight: 600;
        }

        /* Week columns - compact */
        th:nth-child(n+3),
        td:nth-child(n+3) {
            width: 45px;
            min-width: 45px;
        }

        /* BODY CELLS */
        td {
            padding: 5px 3px;
            text-align: center;
            border: 0.5px solid rgba(255, 255, 255, 0.08);
            font-size: 0.65rem;
        }

        /* BANDED ROWS - Elegant alternating */
        tbody tr:nth-child(odd) {
            background: rgba(255, 255, 255, 0.02);
        }

        tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }

        tbody tr:hover {
            background: rgba(132, 250, 176, 0.1);
        }

        /* TOTAL ROW */
        .total-row {
            background: rgba(132, 250, 176, 0.15) !important;
            font-weight: 700;
            border-top: 2px solid #84fab0;
        }

        .total-row td {
            color: #84fab0;
        }

        /* EMPTY CELLS */
        .empty {
            color: rgba(255, 255, 255, 0.3);
        }

        /* MONTH HEADERS - Special styling */
        .month-header th {
            background: rgba(132, 250, 176, 0.1);
            color: #84fab0;
            font-size: 0.7rem;
            padding: 8px 4px;
            border-bottom: 1px solid #84fab0;
        }

        /* LOADING STATE */
        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            h1 {
                font-size: 1rem;
                margin: 10px 0;
            }

            table {
                font-size: 0.6rem;
            }

            th, td {
                padding: 4px 2px;
            }

            th:nth-child(1), td:nth-child(1) {
                width: 50px;
                min-width: 50px;
                font-size: 0.6rem;
            }

            th:nth-child(2), td:nth-child(2) {
                width: 48px;
                min-width: 48px;
                left: 50px;
            }

            th:nth-child(n+3), td:nth-child(n+3) {
                width: 40px;
                min-width: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Weekly Contributions Tracker</h1>
        <div id="root"></div>
    </div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const WEEKLY_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfQdBVl01cxsIoGnfJLltGDuOkIVDFqj-rNg3KwFVZ8-GGbUqk1DSs_CVaygisjaLhg30g1gjzIsdC/pub?gid=2079453016&single=true&output=csv';

        // CSV Parser
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function App() {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                loadData();
            }, []);

            async function loadData() {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const cacheBuster = Date.now();
                    const response = await fetch(`${WEEKLY_CSV_URL}&_=${cacheBuster}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n').filter(line => line.trim());

                    console.log('CSV loaded, total lines:', lines.length);

                    if (lines.length < 4) {
                        throw new Error('Not enough rows in CSV');
                    }

                    // Row 0: Week numbers (1-52)
                    const weekNumbers = parseCSVLine(lines[0]).slice(2);

                    // Row 1: Month names
                    const monthNames = parseCSVLine(lines[1]).slice(2);

                    // Row 2: Headers (Alias, TOTAL AMOUNT, dates...)
                    const headers = parseCSVLine(lines[2]);
                    const weekDates = headers.slice(2);

                    // Build week headers
                    const weekHeaders = weekNumbers.map((weekNum, idx) => ({
                        weekNum: weekNum || '',
                        month: monthNames[idx] || '',
                        dates: weekDates[idx] || ''
                    }));

                    // Parse member rows (start from row 3)
                    const members = [];
                    for (let i = 3; i < lines.length; i++) {
                        const cells = parseCSVLine(lines[i]);
                        if (cells.length < 2) continue;

                        const alias = cells[0]?.trim();
                        if (!alias || alias.toUpperCase() === 'TOTAL') break;

                        const totalAmount = parseFloat(cells[1]?.replace(/,/g, '') || 0);
                        const weeks = cells.slice(2).map(val => {
                            const cleaned = val?.trim().replace(/,/g, '');
                            return cleaned && cleaned !== '-' && cleaned !== '' ? parseFloat(cleaned) : null;
                        });

                        members.push({ alias, totalAmount, weeks });
                    }

                    // Parse TOTAL row
                    const totalLine = lines[lines.length - 1];
                    const totalCells = parseCSVLine(totalLine);
                    const weeklyTotals = totalCells.slice(2).map(val => {
                        const cleaned = val?.trim().replace(/,/g, '');
                        return cleaned && cleaned !== '-' ? parseFloat(cleaned) : 0;
                    });

                    console.log('Parsed data:', { weekHeaders: weekHeaders.length, members: members.length, weeklyTotals: weeklyTotals.length });

                    setData({ weekHeaders, members, weeklyTotals });
                    setLoading(false);

                } catch (err) {
                    console.error('Error loading data:', err);
                    setError(err.message);
                    setLoading(false);
                }
            }

            if (loading) {
                return <div className="loading">Loading weekly contributions...</div>;
            }

            if (error) {
                return (
                    <div className="loading">
                        <p style={{ color: '#ff6464' }}>Error loading data: {error}</p>
                        <button onClick={loadData} style={{ marginTop: '15px', padding: '8px 16px', background: '#84fab0', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>
                            Retry
                        </button>
                    </div>
                );
            }

            if (!data || !data.members || data.members.length === 0) {
                return <div className="loading">No data available</div>;
            }

            const grandTotal = data.members.reduce((sum, m) => sum + m.totalAmount, 0);

            return (
                <div className="table-wrapper">
                    <table>
                        <thead>
                            {/* Month headers */}
                            <tr className="month-header">
                                <th>Alias</th>
                                <th>Total</th>
                                {data.weekHeaders.map((header, idx) => (
                                    <th key={idx}>{header.month}</th>
                                ))}
                            </tr>
                            {/* Week numbers and dates */}
                            <tr>
                                <th></th>
                                <th></th>
                                {data.weekHeaders.map((header, idx) => (
                                    <th key={idx}>
                                        <div>{header.weekNum}</div>
                                        <div style={{ fontSize: '0.55rem', opacity: 0.6, marginTop: '1px' }}>
                                            {header.dates.split('-')[0]}
                                        </div>
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {data.members.map((member, idx) => (
                                <tr key={idx}>
                                    <td>{member.alias}</td>
                                    <td>
                                        {member.totalAmount > 0 ? member.totalAmount.toLocaleString('en-KE', { maximumFractionDigits: 0 }) : '-'}
                                    </td>
                                    {member.weeks.map((amount, weekIdx) => (
                                        <td key={weekIdx} className={amount === null ? 'empty' : ''}>
                                            {amount !== null ? amount.toLocaleString('en-KE', { maximumFractionDigits: 0 }) : '-'}
                                        </td>
                                    ))}
                                </tr>
                            ))}
                            {/* Total row */}
                            <tr className="total-row">
                                <td>TOTAL</td>
                                <td>{grandTotal.toLocaleString('en-KE', { maximumFractionDigits: 0 })}</td>
                                {data.weeklyTotals.map((total, idx) => (
                                    <td key={idx}>
                                        {total > 0 ? total.toLocaleString('en-KE', { maximumFractionDigits: 0 }) : '-'}
                                    </td>
                                ))}
                            </tr>
                        </tbody>
                    </table>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
